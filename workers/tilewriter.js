(()=>{"use strict";var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("worker_threads"),s=require("fs");var n=e.n(s);const r=require("path");var o=e.n(r);const i=require("redis");process.env.PORT,process.env.HOST,parseInt(process.env.USE_MAILER,10),process.env.MAIL_ADDRESS,process.env.CONTACT_ADDRESS;const a=process.env.TILE_FOLDER||"tiles",c=(o().resolve(a),process.env.USE_XREALIP,process.env.BACKUP_URL||null),{PROXYCHECK_KEY:l}=(process.env.BACKUP_DIR,process.env.OUTGOING_ADDRESS,process.env.PUNISH_DOMINATOR,parseInt(process.env.USE_PROXYCHECK,10),process.env),h=process.env.REDIS_URL||"redis://localhost:6379",u=process.env.SHARD_NAME||null,g=(process.env.MYSQL_HOST,process.env.MYSQL_DATABASE,process.env.MYSQL_USER,process.env.MYSQL_PW,process.env.GUILDED_INVITE,parseInt(process.env.LOG_MYSQL,10),parseInt(process.env.HOURLY_EVENT,10),process.env.APISOCKET_KEY,process.env.ADMIN_IDS&&process.env.ADMIN_IDS.split(",").map((e=>parseInt(e,10))),process.env.CORS_HOSTS&&process.env.CORS_HOSTS.split(","),process.env.FACEBOOK_APP_ID,process.env.FACEBOOK_APP_SECRET,process.env.DISCORD_CLIENT_ID,process.env.DISCORD_CLIENT_SECRET,process.env.GOOGLE_CLIENT_ID,process.env.GOOGLE_CLIENT_SECRET,process.env.VK_CLIENT_ID,process.env.VK_CLIENT_SECRET,process.env.REDDIT_CLIENT_ID,process.env.REDDIT_CLIENT_SECRET,parseInt(process.env.CAPTCHA_TIME,10),parseInt(process.env.CAPTCHA_TIMEOUT,10),process.env.SESSION_SECRET,{placePxl:(0,i.defineScript)({NUMBER_OF_KEYS:9,SCRIPT:n().readFileSync(o().resolve("workers","lua","placePixel.lua")),transformArguments:(...e)=>e.map((e=>"string"==typeof e?e:e.toString())),transformReply:e=>e.map((e=>Number(e)))}),allowedChat:(0,i.defineScript)({NUMBER_OF_KEYS:3,SCRIPT:n().readFileSync(o().resolve("workers","lua","allowedChat.lua")),transformArguments:(...e)=>e.map((e=>"string"==typeof e?e:e.toString())),transformReply:e=>e.map((e=>Number(e)))}),getUserRanks:(0,i.defineScript)({NUMBER_OF_KEYS:2,SCRIPT:n().readFileSync(o().resolve("workers","lua","getUserRanks.lua")),transformArguments:(...e)=>e.map((e=>"string"==typeof e?e:e.toString())),transformReply:e=>e.map((e=>Number(e)))}),zmRankRev:(0,i.defineScript)({NUMBER_OF_KEYS:1,SCRIPT:n().readFileSync(o().resolve("workers","lua","zmRankRev.lua")),transformArguments:(e,t)=>[e,...t.map((e=>"string"==typeof e?e:e.toString()))],transformReply:e=>e.map((e=>Number(e)||null))})}),d=(0,i.createClient)(h.startsWith("redis://")?{url:h,scripts:g}:{socket:{path:h},scripts:g}),p={subscriber:null,publisher:null},f=d,m=require("sharp");var S=e.n(m);const w=256,C=2;function b(e,t){return(e%t+t)%t}function $(e){return e?Math.log2(e/w)/C*2:0}function E(e,t){if(!t)return e;if(!e)return t;if(Array.isArray(e))return e.concat(t);if("object"==typeof e){const s=Object.keys(e);return s.includes("columns")?function(e,t){let s;if(e.columns.length===t.columns.length)e.rows=e.rows.concat(t.rows),s=e;else{let n;if(e.columns.length<t.columns.length?(s=t,n=e):(s=e,n=t),!n.rows.length)return s;const r=[];for(let e=0;e<n.rows.length;e+=1)r.push([]);for(let e=0;e<s.columns.length;e+=1){const t=n.columns.indexOf(s.columns[e]);if(~t)for(let e=0;e<n.rows.length;e+=1)r[e].push(n.rows[e][t]);else for(let e=0;e<n.rows.length;e+=1)r[e].push(null)}s.rows=s.rows.concat(r)}"rid"===s.columns[0]&&s.rows.forEach(((e,t)=>{e[0]=t}));const n=s.columns.indexOf("#");if(~n){let e=s.columns.indexOf("canvas");if(-1===e&&(e=s.columns.indexOf("IID")),~e){const t=s.columns.indexOf("time");for(let r=0;r<s.rows.length;r+=1){const o=s.rows[r],i=o[e];if(i&&"N/A"!==i)for(let a=r+1;a<s.rows.length;a+=1){const c=s.rows[a];if(c[e]===i){const e=o[n]+c[n];~t&&o[t]<c[t]&&(s.rows[r]=c),s.rows.splice(a,1),s.rows[r][n]=e,a-=1}}}}}return s}(e,t):(s.forEach((s=>{const n=e[s],r=t[s];e[s]=E(n,r)})),e)}return e+t}const T=require("events");var y=e.n(T);function v(e,t,s){const n=new Uint8Array([193,e,t]);return Buffer.concat([n,s])}class I extends(y()){constructor(){super(),this.onlineCounter={total:0}}async initialize(){}getLowestActiveShard(){return null}amIImportant(){return!0}onAsync(e,t){this.on(e,((...e)=>{setImmediate((()=>{t(...e)}))}))}req(e,...t){return new Promise(((s,n)=>{const r=Math.floor(1e5*Math.random()).toString()+Math.floor(1e5*Math.random()).toString(),o=`res:${r}`;let i;const a=e=>{clearTimeout(i),s(e)};i=setTimeout((()=>{this.off(o,a),n(new Error(`Timeout on req ${e}`))}),45e3),this.once(o,a),this.emit(`req:${e}`,r,...t)}))}res(e,t){this.emit(`res:${e}`,t)}onReq(e,t){this.on(`req:${e}`,(async(e,...s)=>{const n=await t(...s);this.res(e,n)}))}broadcastPixels(e,t,s){const n=t>>8,r=255&t,o=v(n,r,s);this.emit("pixelUpdate",e,t,o),this.emit("chunkUpdate",e,[n,r])}broadcastChunkUpdate(e,t){this.emit("chunkUpdate",e,t)}sendMail(...e){this.emit("mail",...e)}recvChatMessage(e,t,s){this.emit("recvChatMessage",e,t,s)}setCoolDownFactor(e){this.emit("setCoolDownFactor",e)}broadcastChatMessage(e,t,s,n,r="xx",o=!0){this.emit("chatMessage",e,t,s,n,r||"xx",o)}broadcastSUChatMessage(e,t,s,n,r,o="xx"){this.emit("suChatMessage",e,t,s,n,r,o||"xx")}broadcastAddChatChannel(e,t,s){this.emit("addChatChannel",e,t,s)}broadcastRemoveChatChannel(e,t){this.emit("remChatChannel",e,t)}broadcastRateLimitTrigger(e,t){this.emit("rateLimitTrigger",e,t)}rankingListUpdate(e){this.emit("rankingListUpdate",e)}reloadUser(e){this.emit("reloadUser",e)}broadcastOnlineCounter(e){this.onlineCounter=e,this.emit("onlineCounter",e)}}const O=I,R="bc",U="l",k=u?new class extends O{constructor(){super(),this.isCluster=!0,this.thisShard=u,this.csReq=[],this.pings={},this.shards={},this.shardOnlineCounters=[],this.publisher={publish:()=>{}},this.subscriber={subscribe:()=>{},unsubscribe:()=>{}},this.checkHealth=this.checkHealth.bind(this),setInterval(this.checkHealth,1e4)}async initialize(){this.publisher=p.publisher,this.subscriber=p.subscriber,await this.connectBCChannel(),await this.connectShardChannel(),await new Promise((e=>{setTimeout(e,25e3)})),console.log("CLUSTER: Initialized message broker")}async connectBCChannel(){await this.subscriber.subscribe(R,((...e)=>{this.onShardBCMessage(...e)})),this.pings[R]=Date.now()}async connectShardChannel(){const e=`${U}:${this.thisShard}`;await this.subscriber.subscribe(e,((...e)=>{this.onShardListenMessage(...e)})),this.pings[e]=Date.now()}async onShardBCMessage(e){try{const t=Date.now();if(e.startsWith(this.thisShard))return void(this.pings[R]=t);const s=e.indexOf(",");if(~s){const t=e.slice(e.indexOf(":")+1,s);console.log("CLUSTER: Broadcast",t);const n=JSON.parse(e.slice(s+1));if(t.startsWith("req:")){const t=e.slice(0,e.indexOf(":")),s=n[0];this.csReq.push({id:s,shard:t,ts:Date.now()})}return void super.emit(t,...n)}this.shards[e]||(console.log(`CLUSTER: Shard ${e} connected`),await this.subscriber.subscribe(e,(t=>this.onShardBinaryMessage(t,e)),!0),this.publisher.publish(R,this.thisShard)),this.pings[e]=t,this.shards[e]=t}catch(e){console.error(`CLUSTER: Error on broadcast message: ${e.message}`)}}async onShardListenMessage(e){try{if("ping"===e){const e=`${U}:${this.thisShard}`;return void(this.pings[e]=Date.now())}const t=e.indexOf(","),s=e.slice(0,t);console.log(`CLUSTER shard listener got ${s}`);const n=JSON.parse(e.slice(t+1));super.emit(s,...n)}catch(e){console.error(`CLUSTER: Error on listener message: ${e.message}`)}}getLowestActiveShard(){let e=0,t=null;return this.shardOnlineCounters.forEach((s=>{const[n,r]=s;(r.total<e||!t)&&(t=n,e=r.total)})),t||this.thisShard}amIImportant(){return!this.shardOnlineCounters[0]||this.shardOnlineCounters[0][0]===this.thisShard}req(e,...t){return new Promise(((s,n)=>{const r=Math.floor(1e5*Math.random()).toString()+Math.floor(1e5*Math.random()).toString(),o=`res:${r}`;let i,a=this.shardOnlineCounters.length,c=null;const l=t=>{a-=1,c=E(c,t),a<=0?(console.log(`CLUSTER res:${r}:${e} finished`),this.off(o,l),clearTimeout(i),s(c)):console.log(`CLUSTER got res:${r}:${e} from shard, ${a} still left`)};i=setTimeout((()=>{this.off(o,l),c?s(c):n(new Error(`CLUSTER Timeout on wait for res:${r}:${e}`))}),45e3),this.on(o,l),this.emit(`req:${e}`,r,...t)}))}res(e,t){const s=this.csReq.find((t=>t.id===e));console.log(`CLUSTER send res:${e} to shard ${s&&s.shard}`),s?(this.publisher.publish(`${U}:${s.shard}`,`res:${e},${JSON.stringify([t])}`),this.csReq=this.csReq.filter((t=>t.id!==e))):super.emit(`res:${e}`,t)}updateShardOnlineCounter(e,t){const s=this.shardOnlineCounters.find((t=>t[0]===e));s?s[1]=t:(this.shardOnlineCounters.push([e,t]),this.shardOnlineCounters.sort(((e,t)=>e[0].localeCompare(t[0])))),this.sumOnlineCounters()}removeShardFromOnlienCounter(e){const t=this.shardOnlineCounters.findIndex((t=>t[0]===e));~t&&this.shardOnlineCounters.splice(t,1)}onShardBinaryMessage(e,t){try{switch(e[0]){case 197:{const t=function(e){const t=e[1];return e.writeUInt8(193,1),[t,e.readUInt16BE(2),Buffer.from(e.buffer,e.byteOffset+1,e.length-1)]}(e);super.emit("pixelUpdate",...t);const s=t[1],n=[s>>8,255&s];super.emit("chunkUpdate",t[0],n);break}case 196:super.emit("chunkUpdate",...(s=e,[s[1],[s.readUInt8(2),s.readUInt8(3)]]));break;case 167:{const s=function(e){const t={};t.total=e.readUInt16BE(1);let s=e.length;for(;s>3;){const n=e.readUInt16BE(s-=2);t[e.readUInt8(s-=1)]=n}return t}(e);this.updateShardOnlineCounter(t,s),this.pings[t]=Date.now();break}}}catch(e){console.error(`CLUSTER: Error on binary message of shard ${t}: ${e.message}`)}var s}sumOnlineCounters(){const e={};this.shardOnlineCounters.forEach((t=>{const[,s]=t;Object.keys(s).forEach((t=>{const n=s[t];e[t]?e[t]+=n:e[t]=n}))})),this.onlineCounter=e}emit(e,...t){super.emit(e,...t);const s=`${this.thisShard}:${e},${JSON.stringify(t)}`;this.publisher.publish(R,s)}broadcastPixels(e,t,s){const n=t>>8,r=255&t;this.publisher.publish(this.thisShard,function(e,t,s,n){const r=new Uint8Array([197,e,t,s]);return Buffer.concat([r,n])}(e,n,r,s));const o=v(n,r,s);super.emit("pixelUpdate",e,t,o),super.emit("chunkUpdate",e,[n,r])}setCoolDownFactor(e){this.amIImportant()?this.emit("setCoolDownFactor",e):super.emit("setCoolDownFactor",e)}recvChatMessage(e,t,s){super.emit("recvChatMessage",e,t,s)}broadcastChunkUpdate(e,t){this.publisher.publish(this.thisShard,function(e,[t,s]){return Buffer.from([196,e,t,s])}(e,t)),super.emit("chunkUpdate",e,t)}broadcastOnlineCounter(e){this.updateShardOnlineCounter(this.thisShard,e);const t=function(e){const t=Object.keys(e).filter((e=>"total"!==e)),s=Buffer.allocUnsafe(3+3*t.length);s.writeUInt8(167,0),s.writeUInt16BE(e.total,1);let n=1;for(let r=0;r<t.length;r+=1){const o=t[r],i=e[o];s.writeUInt8(Number(o),n+=2),s.writeUInt16BE(i,n+=1)}return s}(e);this.publisher.publish(this.thisShard,t),super.emit("onlineCounter",this.onlineCounter)}async checkHealth(){let e=Date.now()-3e4;const{shards:t,pings:s}=this;try{for(const[n,r]of Object.entries(t))r<e&&(console.log(`CLUSTER: Shard ${n} disconnected`),this.removeShardFromOnlienCounter(n),await this.subscriber.unsubscribe(n),delete s[n],delete t[n]);for(const[n,r]of Object.entries(s))r<e&&(await this.subscriber.unsubscribe(n),delete s[n],n===R?(console.warn("CLUSTER: Broadcaset channel broken, reconnect"),await this.connectBCChannel()):n.startsWith(`${U}:`)?(console.warn("CLUSTER: Shard text channel broken, reconnect"),await this.connectShardChannel()):(console.warn(`CLUSTER: Binary channel to shard ${n} broken`),this.removeShardFromOnlienCounter(n),delete t[n]))}catch(e){console.error(`CLUSTER: Error on health check: ${e.message}`)}this.publisher.publish(R,this.thisShard),this.publisher.publish(`${U}:${this.thisShard}`,"ping"),e-=3e4,this.csReq=this.csReq.filter((t=>t.ts>e))}}:new O;class _{static async getChunk(e,t,s,n=null){const r=`ch:${e}:${t}:${s}`;let o=await f.get((0,i.commandOptions)({returnBuffers:!0}),r);if(n>0&&o&&o.length<n){const e=Buffer.alloc(n-o.length);o=Buffer.concat([o,e])}return o}static async setChunk(e,t,s,n){const r=`ch:${n}:${e}:${t}`;return await f.set(r,Buffer.from(s.buffer)),k.broadcastChunkUpdate(n,[e,t]),!0}static async delChunk(e,t,s){const n=`ch:${s}:${e}:${t}`;return await f.del(n),k.broadcastChunkUpdate(s,[e,t]),!0}multi=null;static enqueuePixel(e,t,s,n,r){_.multi||(_.multi=f.multi(),setTimeout(_.flushPixels,100)),_.multi.addCommand(["BITFIELD",`ch:${e}:${s}:${n}`,"SET","u8",`#${r}`,String(t)])}static flushPixels(){if(_.multi){const{multi:e}=_;return _.multi=null,e.exec(!0)}return null}static async getPixelIfExists(e,t,s,n){const r=["BITFIELD",`ch:${e}:${t}:${s}`,"GET","u8",`#${n}`],o=await f.sendCommand(r);return o?o[0]:null}static async getPixelByOffset(e,t,s,n){const r=_.getPixelIfExists(e,t,s,n);return null==r?0:r}static async getPixel(e,t,s,n,r=null){const[o,i]=function(e,t,s,n=null){const r=null===n?w:32,o=null==n?s:n;return[Math.floor((t+e/2)/r),Math.floor((o+e/2)/r)]}(t,s,n,r),a=function(e,t,s,n=null){const r=null===n?w:32,o=null==n?s:n;let i=null===n?0:s*r*r;const a=b(e/2,r),c=b(t+a,r);return i+=b(o+a,r)*r+c,i}(t,s,n,r),c=_.getPixelIfExists(e,o,i,a);return null==c?0:c}}const D=_,x=class{length;rgb;colors;abgr;fl;constructor(e){this.length=e.length,this.rgb=new Uint8Array(3*this.length),this.colors=new Array(this.length),this.abgr=new Uint32Array(this.length),this.fl=new Array(this.length);let t=0;for(let s=0;s<e.length;s++){const n=e[s][0],r=e[s][1],o=e[s][2];this.rgb[t++]=n,this.rgb[t++]=r,this.rgb[t++]=o,this.colors[s]=`rgb(${n}, ${r}, ${o})`,this.abgr[s]=4278190080|o<<16|r<<8|n,this.fl[s]=[n/256,r/256,o/256]}}isDark(e){return e*=3,.2126*this.rgb[e++]+.7152*this.rgb[e++]+.0722*this.rgb[e]<128}getIndexOfColor(e,t,s){const{rgb:n}=this;let r=n.length/3;for(;r>0;){r-=1;const o=3*r;if(n[o]===e&&n[o+1]===t&&n[o+2]===s)return r}return null}getClosestIndexOfColor(e,t,s){const{rgb:n}=this;let r=n.length/3,o=0,i=null;for(;r>0;){r-=1;const a=3*r;let c=(n[a]-e)**2;c+=(n[a+1]-t)**2,c+=(n[a+2]-s)**2,(null===i||i>c)&&(o=r,i=c)}return o}};function M(e,t,s,n,r){const[o,i]=n,a=(o+i*e*s)*e,[c,l,h]=t.rgb;for(let t=0;t<e;t+=1){let n=3*(a+t*e*s);const o=n+3*e;for(;n<o;)r[n++]=c,r[n++]=l,r[n++]=h}}function A(e,t,s,n,r){const o=w,[i,a]=s,c=(i+a*t*o)*o,{rgb:l}=e,h=l[0],u=l[1],g=l[2];let d,p=0;for(let e=0;e<o;e+=1){let s=3*(c+e*o*t);const i=s+3*o;for(;s<i;)p<n.length?(d=3*(63&n[p++]),r[s++]=l[d++],r[s++]=l[d++],r[s++]=l[d]):(r[s++]=h,r[s++]=u,r[s++]=g)}}function L(e,t){const[s,r,i]=t,a=o().resolve(e,String(s),String(r),`${i}.webp`);try{const e=new Date(n().statSync(a).mtime).getTime();if(Date.now()-e<12e4)return null}catch{}return a}async function P(e,t,s,n,r=null){const o=r||new x(t.colors),i=t.size,[a,c]=n,l=L(s,[$(i)-1,a,c]);if(!l)return!0;const h=new Uint8Array(w*w*C*C*3),u=Date.now(),g=a*C,d=c*C,p=[],f=async(t,s)=>{try{const n=await D.getChunk(e,g+t,d+s);if(!n||!n.length)return void p.push([t,s]);A(o,C,[t,s],n,h)}catch(n){p.push([t,s]),console.error(`Tiling: Failed to get Chunk ch:${e}:${g+t}${d+s} with error ${n.message}`)}},m=[];for(let e=0;e<C;e+=1)for(let t=0;t<C;t+=1)m.push(f(t,e));if(await Promise.all(m),p.length!==C*C){p.forEach((e=>{M(w,o,C,e,h)}));try{await S()(h,{raw:{width:w*C,height:w*C,channels:3}}).resize(w).webp({quality:100,smartSubsample:!0}).toFile(l)}catch(e){return console.error(`Tiling: Error on createZoomTileFromChunk: ${e.message}`),!1}return console.log(`Tiling: Created Tile ${l} with ${p.length} empty chunks in ${Date.now()-u}ms`),!0}return!1}async function B(e,t,s,r=null){const o=r||new x(e.colors),i=new Uint8Array(w*w*3),[a,c,l]=s,h=L(t,[a,c,l]);if(!h)return!0;const u=Date.now(),g=[],d=async(e,s)=>{const r=`${t}/${a+1}/${c*C+e}/${l*C+s}.webp`;try{if(!n().existsSync(r))return void g.push([e,s]);const t=await S()(r).removeAlpha().raw().toBuffer();!function(e,t,s,n){const r=w,[o,i]=t,a=r/e,c=(o+i*r)*a;let l,h=0;const u=3*(e-1),g=3*(r*(e-1)-1);for(let e=0;e<a;e+=1){let t=3*(c+e*r);const o=t+3*a;for(;t<o;){const e=s[h++],r=s[h++],o=s[h++];h+=u,l=h+g,n[t++]=s[l++]+e>>>1,n[t++]=s[l++]+r>>>1,n[t++]=s[l]+o>>>1}h=l+1}}(C,[e,s],t,i)}catch(t){g.push([e,s]),console.error(`Tiling: Error on createZoomedTile on chunk ${r}: ${t.message}`)}},p=[];for(let e=0;e<C;e+=1)for(let t=0;t<C;t+=1)p.push(d(t,e));if(await Promise.all(p),g.length!==C*C){g.forEach((e=>{M(w/C,o,C,e,i)}));try{await S()(i,{raw:{width:w,height:w,channels:3}}).webp({quality:100,smartSubsample:!0}).toFile(h)}catch(e){return console.error(`Tiling: Error on createZoomedTile: ${e.message}`),!1}return console.log(`Tiling: Created tile ${h} with ${g.length} empty subtiles in ${Date.now()-u}ms.`),!0}return!1}async function N(e,t,s){const r=new x(t.colors),i=t.size,a=Math.min(i,4096),c=a/w,l=Math.log2(c)*Math.log2(C),h=new Uint8Array(a*a*3),u=Date.now(),g=[],d=a!==i?async(e,t)=>{const r=`${s}/${l}/${e}/${t}.webp`;try{if(!n().existsSync(r))return void g.push([e,t]);const s=await S()(r).removeAlpha().raw().toBuffer();!function(e,t,s,n){const r=w,[o,i]=t,a=(o+i*e*r)*r;let c=0;for(let t=0;t<r;t+=1){let o=3*(a+t*r*e);const i=o+3*r;for(;o<i;)n[o++]=s[c++],n[o++]=s[c++],n[o++]=s[c++]}}(c,[e,t],s,h)}catch(s){g.push([e,t]),console.error(`Tiling: Error on createTexture in chunk ${r}: ${s.message}`)}}:async(t,s)=>{try{let n=null;if(n=await D.getChunk(e,t,s),!n||!n.length)return void g.push([t,s]);A(r,c,[t,s],n,h)}catch(n){g.push([t,s]),console.error(`Tiling: Failed to get Chunk ch:${e}:${t}${s} with error ${n.message}`)}},p=[];for(let e=0;e<c;e+=1)for(let t=0;t<c;t+=1)p.push(d(t,e));await Promise.all(p),g.forEach((e=>{M(w,r,c,e,h)}));const f=o().resolve(s,"texture.webp");try{await S()(h,{raw:{width:a,height:a,channels:3}}).toFile(f)}catch(e){return void console.error(`Tiling: Error on createTexture: ${e.message}`)}console.log(`Tiling: Created texture in ${(Date.now()-u)/1e3}s.`)}if(t.isMainThread)throw new Error("Tilewriter is run as a worker thread, not as own process");(async()=>{if(console.log(`Connecting to redis server at ${h}`),await d.connect(),u&&t.isMainThread){const e=d.duplicate();await e.connect(),p.publisher=d,p.subscriber=e}c?.includes("pixmap.fun")&&d.flushAll("ASYNC")})().then((()=>{t.parentPort.on("message",(async e=>{const{task:s,args:r}=e;try{switch(s){case"createZoomTileFromChunk":await P(...r);break;case"createZoomedTile":await B(...r);break;case"createTexture":await N(...r);break;case"initializeTiles":await async function(e,t,s,r=!1){console.log(`Tiling: Initializing tiles in ${s}, forceint = ${r}`);const i=Date.now(),a=new x(t.colors),c=$(t.size);await async function(e,t){const s=new Uint8Array(w*w*3);let n=0;const r=w*w*3;for(;n<r;)s[n++]=t.rgb[0],s[n++]=t.rgb[1],s[n++]=t.rgb[2];const i=o().resolve(e,"emptytile.webp");try{await S()(s,{raw:{width:w,height:w,channels:3}}).webp({quality:100,smartSubsample:!0}).toFile(i)}catch(e){return void console.error(`Tiling: Error on createEmptyTile: ${e.message}`)}console.log(`Tiling: Created empty tile at ${i}`)}(s,a);let l=c-1,h=o().resolve(s,String(l));console.log(`Tiling: Checking zoomlevel ${h}`),n().existsSync(h)||n().mkdirSync(h);let u=0,g=0;const d=C**l;for(let i=0;i<d;i+=1){const c=o().resolve(s,String(l),String(i));n().existsSync(c)||n().mkdirSync(c);for(let c=0;c<d;c+=1){const h=o().resolve(s,String(l),String(i),`${c}.webp`);!r&&n().existsSync(h)||(await P(e,t,s,[i,c],a)&&(g+=1),u+=1)}}for(console.log(`Tiling: Created ${g} / ${u} tiles for basezoom of canvas${e}`),l=c-2;l>=0;l-=1){u=0,g=0,h=o().resolve(s,String(l)),console.log(`Tiling: Checking zoomlevel ${h}`),n().existsSync(h)||n().mkdirSync(h);const i=C**l;for(let e=0;e<i;e+=1){const c=o().resolve(s,String(l),String(e));n().existsSync(c)||n().mkdirSync(c);for(let c=0;c<i;c+=1){const i=o().resolve(s,String(l),String(e),`${c}.webp`);!r&&n().existsSync(i)||(await B(t,s,[l,e,c],a)&&(g+=1),u+=1)}}console.log(`Tiling: Created ${g} / ${u} tiles for zoom ${l} for canvas${e}`)}await N(e,t,s),console.log(`Tiling: Elapsed Time: ${Math.round((Date.now()-i)/1e3)} for canvas${e}`)}(...r);break;default:console.warn(`Tiling: Main thread requested unknown task ${s}`)}t.parentPort.postMessage("Done!")}catch(e){console.warn(`Tiling: Error on executing task ${s} args ${r}: ${e.message}`),t.parentPort.postMessage("Failure!")}}))}))})();